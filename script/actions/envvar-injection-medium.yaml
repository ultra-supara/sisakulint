name: Environment Variable Injection Medium - Normal Triggers
on:
  # Normal triggers with limited permissions
  pull_request:
    types: [opened, synchronize]
  push:
    branches: [main]
  schedule:
    - cron: '0 0 * * *'

jobs:
  # MEDIUM: Untrusted input written to GITHUB_ENV with normal trigger
  unsafe-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Set env from PR title
        run: |
          echo "PR_TITLE=${{ github.event.pull_request.title }}" >> "$GITHUB_ENV"

      - name: Use the env var
        run: 'echo "Title: $PR_TITLE"'

  # MEDIUM: Untrusted input from PR body
  unsafe-pr-body:
    runs-on: ubuntu-latest
    steps:
      - name: Set env from PR body
        run: |
          echo "PR_BODY=${{ github.event.pull_request.body }}" >> $GITHUB_ENV

  # MEDIUM: Untrusted input from head ref
  unsafe-head-ref:
    runs-on: ubuntu-latest
    steps:
      - name: Set env from head ref
        run: |
          echo "HEAD_REF=${{ github.event.pull_request.head.ref }}" >> "$GITHUB_ENV"

  # MEDIUM: Multiple untrusted inputs
  unsafe-multiple:
    runs-on: ubuntu-latest
    steps:
      - name: Set multiple env vars
        run: |
          echo "TITLE=${{ github.event.pull_request.title }}" >> $GITHUB_ENV
          echo "AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

  # SAFE: Using tr -d '\n' to remove newlines
  safe-with-tr:
    runs-on: ubuntu-latest
    steps:
      - name: Set env safely with tr
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          echo "PR_TITLE=$(echo "$PR_TITLE" | tr -d '\n')" >> "$GITHUB_ENV"

  # SAFE: Using heredoc with unique delimiter
  safe-with-heredoc:
    runs-on: ubuntu-latest
    steps:
      - name: Set multiline env safely
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          EOF_MARKER="EOF_$(date +%s%N)"
          {
            echo "PR_BODY<<$EOF_MARKER"
            echo "$PR_BODY"
            echo "$EOF_MARKER"
          } >> "$GITHUB_ENV"

  # SAFE: Using environment variables as intermediary
  safe-with-env:
    runs-on: ubuntu-latest
    steps:
      - name: Process with env var
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          # Process the title safely
          SANITIZED=$(echo "$PR_TITLE" | tr -d '\n' | tr -d '\r')
          echo "SANITIZED_TITLE=$SANITIZED" >> "$GITHUB_ENV"

  # SAFE: Not using untrusted input
  safe-trusted-only:
    runs-on: ubuntu-latest
    steps:
      - name: Set env from trusted sources
        run: |
          echo "SHA=${{ github.sha }}" >> "$GITHUB_ENV"
          echo "REF=${{ github.ref }}" >> "$GITHUB_ENV"
          echo "REPO=${{ github.repository }}" >> "$GITHUB_ENV"
