name: CI
on: [push, pull_request]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v5
        with:
          go-version: "1.21.3"
      - name: Check Go sources are formatted
        run: |
          diffs="$(gofmt -d ./src/core/*.go ./cmd/sisakulint/*.go)"
          if [[ "$diffs" != "" ]]; then
            echo "$diffs" >&2
            exit 1
          fi
      - name: Install staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
      - name: Lint bash scripts
        run: shellcheck ./download.bash
  docker:
    name: Dockerfile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build image
        id: image
        uses: docker/build-push-action@v3
        with:
          build-args: |
            GOLANG_VER=1.21.3
          push: false
      - name: Test Docker image
        run: docker container run
          --mount type=bind,source="$(pwd)",target=/mnt/app
          --workdir /mnt/app
          -- ${{ steps.image.outputs.digest }}  -debug
      - name: Lint Dockerfile with hadolint
        run: docker run --rm -i hadolint/hadolint hadolint --ignore DL3018 --strict-labels - < Dockerfile
