# sisakulint 要件定義書

## 概要

sisakulintは、GitHub Actionsのワークフローファイル（.github/workflows/*.yml または .yaml）を対象とした静的解析ツールです。このツールは、GitHub Actionsのワークフローにおけるセキュリティ問題やベストプラクティスに関する違反を検出します。OWASPのCI/CDセキュリティリスクトップ10に準拠し、GitHub Actionsのセキュリティ機能に関するガイドラインに従った静的解析を行います。また、自動修正機能も提供し、SARIFフォーマットでの出力をサポートしています。

## ユーザストーリー

### ストーリー1: セキュリティエンジニアとしての静的解析

- **である** セキュリティエンジニア **として**
- **私は** GitHub Actionsのワークフローファイルに対する静的解析を実行 **したい**
- **そうすることで** CI/CDパイプラインに存在する潜在的なセキュリティリスクを早期に検出できる

### ストーリー2: 開発者としての自動修正

- **である** 開発者 **として**
- **私は** 検出された問題を自動的に修正 **したい**
- **そうすることで** 開発効率を向上させつつ、セキュアなワークフローを維持できる

### ストーリー3: チームリーダーとしてのセキュリティポリシー適用

- **である** チームリーダー **として**
- **私は** 組織全体で一貫したセキュリティポリシーを適用 **したい**
- **そうすることで** プロジェクト全体でのセキュリティ基準の遵守を確保できる

### ストーリー4: DevOpsエンジニアとしてのCI/CDパイプラインの統合

- **である** DevOpsエンジニア **として**
- **私は** sisakulintをCI/CDパイプラインに統合 **したい**
- **そうすることで** 継続的なセキュリティチェックを自動化できる

### ストーリー5: コードレビュアーとしてのレビュープロセスの向上

- **である** コードレビュアー **として**
- **私は** SARIFフォーマットでの結果を活用してレビュープロセスを向上 **したい**
- **そうすることで** GitHub上での効率的なエラーのトリアージが可能になる

## 機能要件（EARS記法）

### 通常要件（SHALL）

- REQ-001: システムはGitHub Actionsのワークフローファイル（.github/workflows/*.yml または .yaml）を解析しなければならない
- REQ-002: システムは検出された問題の詳細な情報と該当する箇所を出力しなければならない
- REQ-003: システムはID衝突を検出しなければならない
- REQ-004: システムはハードコードされた認証情報を検出しなければならない
- REQ-005: システムは不適切なコミットSHAの使用を検出しなければならない
- REQ-006: システムは権限設定の問題を検出しなければならない
- REQ-007: システムはワークフローコールの問題を検出しなければならない
- REQ-008: システムはタイムアウト設定の欠如を検出しなければならない
- REQ-009: システムはスクリプトインジェクション脆弱性を検出しなければならない
- REQ-010: システムは検出された問題のSARIFフォーマットでの出力をサポートしなければならない

### 条件付き要件（WHEN/IF-THEN）

- REQ-101: `-fix on` オプションが指定された場合、システムは検出された問題を自動的に修正しなければならない
- REQ-102: `-fix dry-run` オプションが指定された場合、システムは修正内容をプレビューとして表示し、実際の変更は行わなければならない
- REQ-103: `-debug` オプションが指定された場合、システムはデバッグ情報を出力しなければならない
- REQ-104: `-format "{{sarif .}}"` オプションが指定された場合、システムはSARIFフォーマットで結果を出力しなければならない
- REQ-105: `-init` オプションが指定された場合、システムはデフォルトの設定ファイルを生成しなければならない
- REQ-106: `-boilerplate` オプションが指定された場合、システムはボイラープレートテンプレートを生成しなければならない

### 状態要件（WHERE）

- REQ-201: `.github/workflows`ディレクトリが存在する場合、システムは自動的にそのディレクトリ内のワークフローファイルを解析しなければならない
- REQ-202: 設定ファイル（.github/action.yaml）が存在する場合、システムはその設定を読み込んで適用しなければならない

### オプション要件（MAY）

- REQ-301: システムは特定のルールの無効化をサポートしてもよい
- REQ-302: システムはカスタムルールの追加をサポートしてもよい
- REQ-303: システムは特定のファイルパターンの除外をサポートしてもよい

### 制約要件（MUST）

- REQ-401: システムはYAML構文で表現できないインスペクションをサポートしてはならない
- REQ-402: システムは「リポジトリレベルの設定」をサポートしてはならない

## 非機能要件

### パフォーマンス

- NFR-001: システムは大規模なリポジトリでも1分以内にすべてのワークフローファイルを解析できなければならない
- NFR-002: システムは最小限のメモリフットプリントで動作しなければならない（100MB未満）
- NFR-003: システムはGitHub Actionsのワークフローファイル解析において99%以上の精度で問題を検出しなければならない

### セキュリティ

- NFR-101: システムはユーザの認証情報を保存または送信してはならない
- NFR-102: システムはOWASPのCI/CDセキュリティリスクトップ10の検出に対応しなければならない
- NFR-103: システムは定期的に最新のGitHub Actionsセキュリティベストプラクティスに更新されなければならない

### ユーザビリティ

- NFR-201: システムはわかりやすいエラーメッセージを提供し、修正方法の参考ドキュメントへのリンクを含まなければならない
- NFR-202: システムはHomebrewを通じて簡単にインストールできなければならない
- NFR-203: システムは詳細な使用方法と各ルールの説明を含むドキュメントを提供しなければならない
- NFR-204: システムはコマンドラインで直感的に使用できるインターフェースを提供しなければならない

### 互換性

- NFR-301: システムはmacOSとLinux環境で動作しなければならない
- NFR-302: システムはreviewdogと連携して機能しなければならない
- NFR-303: システムは継続的インテグレーション環境でのバッチ処理に対応しなければならない

## Edgeケース

### エラー処理

- EDGE-001: 無効なYAML構文を含むファイルを解析する場合、システムは明確なエラーメッセージを表示し、可能な限り問題の箇所を特定しなければならない
- EDGE-002: 権限のないディレクトリやファイルにアクセスしようとした場合、システムは適切なエラーメッセージを表示しなければならない
- EDGE-003: 不完全なワークフローファイル（必須フィールドの欠如など）を解析する場合、システムは部分的な解析を行い、検出できる問題については報告しなければならない
- EDGE-004: 巨大なワークフローファイル（1MB以上）を処理する場合でも、システムはメモリ使用量を最適化し、解析を完了しなければならない

### 境界値

- EDGE-101: 非常に多数のワークフローファイル（100以上）を含むリポジトリでも、システムは効率的に処理しなければならない
- EDGE-102: 非常に長い行（10,000文字以上）を含むファイルでも、システムは適切に処理しなければならない
- EDGE-103: 複雑な条件式や大量のネストを含むワークフローでも、システムは正確に解析しなければならない
- EDGE-104: 複数の同時実行（並列処理）においても、システムは安定して動作しなければならない

## 受け入れ基準

### 機能テスト

- [ ] すべての定義されたルール（ID衝突、認証情報、コミットSHA、権限、ワークフローコール、タイムアウト、スクリプトインジェクション）が正しく検出されることを確認する
- [ ] 自動修正機能が適切に問題を修正することを確認する
- [ ] すべてのコマンドラインオプションが意図した通りに機能することを確認する
- [ ] SARIFフォーマット出力が正しく生成され、reviewdogと連携できることを確認する
- [ ] ユーザー設定ファイルが正しく読み込まれ、適用されることを確認する

### 非機能テスト

- [ ] 大規模なリポジトリ（多数のワークフローファイルを含む）での解析パフォーマンスを測定し、1分以内に完了することを確認する
- [ ] メモリ使用量が100MB未満であることを確認する
- [ ] macOSとLinux環境での動作を確認する
- [ ] 明確なエラーメッセージと参考ドキュメントへのリンクが提供されることを確認する
- [ ] CI環境での自動実行が問題なく機能することを確認する